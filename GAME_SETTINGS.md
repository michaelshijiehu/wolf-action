# 狼人杀法官助手 - 项目记忆与设置存档

## 🚀 当前稳定配置 (2026-01-19)

### 1. 核心逻辑规则 (Logic Rules)
- **原子化数据更新**：后端 `nextPhase` 产生的所有变更（死亡状态、阶段、日志、UI指令）必须汇总到同一个 `updates` 对象中，执行**单次** `db.update`。这是消除界面跳动的根本方案。
- **游戏节奏 (Pacing)**：
  - **语音优先**：倒计时必须在所有语音播放结束后才开始。
  - **30s 规则**：语音播报完毕后，统一给玩家 30 秒的操作时间。
  - **3s 缓冲**：如果没有播放语音（仅显示文字提示），前端给予 3 秒阅读缓冲后再开始 30s 倒计时。
- **复读机防御**：放逐结算完成后，立即物理擦除 `day_votes` 字段。

### 2. 对局记录系统 (Game Records)
- **唯一性**：记录 ID 采用 `RoomID_StartTime` 格式，使用 `set` 操作，确保每局游戏仅产生一条总记录。
- **完整性**：记录必须包含 `config.roles`（配置）、`death_reason`（死因）、`timeline`（全流程日志）。
- **映射映射 (Mapping)**：
  - `kill` -> 狼人袭击
  - `poison` -> 女巫毒杀
  - `hunter_shoot` -> 猎人带走
  - `love` -> 情侣殉情
  - `milk` -> 奶穿(同守同救)
  - `vote` -> 投票放逐

### 3. 已知 Bug 修复记录
- **1s/5s 跳转问题**：已移除 `simulateBotActions` 中的自动阶段跳转逻辑。现在点击“模拟”后，数据填入数据库，但阶段仍由计时器或法官手动控制。
- **记录缺失问题**：修复了 `applyUpdates` 在处理嵌套路径字符串时的逻辑，现在数据快照保存非常稳健。
- **Loading 配对**：前端所有异步操作均已通过 `try...finally` 强制关闭加载动画。

## 🛠️ 下次迭代计划
1.  **选票详情可视化**：在对局记录里显示每一轮具体的投票关系（如：1 投了 4）。
2.  **新角色支持**：计划加入骑士、白痴的具体技能反馈逻辑。
3.  **网络抗性**：优化 WebSocket 断线重连时的房间状态恢复。
