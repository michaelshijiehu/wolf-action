<view class="container">
  <block wx:if="{{record}}">
    <view class="detail-card">
      <view class="detail-header">
        <text class="record-date">{{record.record_date}}</text>
        <text class="record-winner {{record.winner === 'good' ? 'winner-good' : 'winner-werewolf'}}">
          {{record.winner === 'good' ? 'å¥½äººèƒœåˆ©' : 'ç‹¼äººèƒœåˆ©'}}
        </text>
      </view>
      <view class="section-title">æ¸¸æˆé…ç½®</view>
      <view class="config-grid">
        <view class="config-item">ç‹¼äºº: {{record.config.roles.werewolf}}</view>
        <view class="config-item">æ‘æ°‘: {{record.config.roles.villager}}</view>
        <view class="config-item">é¢„è¨€å®¶: {{record.config.roles.seer || 0}}</view>
        <view class="config-item">å¥³å·«: {{record.config.roles.witch || 0}}</view>
        <view class="config-item">çŒäºº: {{record.config.roles.hunter || 0}}</view>
        <view class="config-item">ç™½ç—´: {{record.config.roles.idiot || 0}}</view>
        <view class="config-item">å®ˆå«: {{record.config.roles.guard || 0}}</view>
        <view class="config-item">ä¸˜æ¯”ç‰¹: {{record.config.roles.cupid || 0}}</view>
      </view>
      <view class="section-title">ç©å®¶è¯¦æƒ…</view>
      <view class="player-list-detail">
        <block wx:for="{{record.players}}" wx:for-item="player" wx:key="seat">
          <view class="player-item-detail {{player.is_alive ? '' : 'dead'}}">
            <image class="player-avatar-detail" src="{{player.avatar_url || '../../images/icons/avatar.png'}}"></image>
            <view class="player-info-detail">
              <text class="player-name-detail">{{player.nickname}} ({{player.seat}}å·)</text>
              <text class="player-role-detail">{{utils.getRoleName(player.role)}}</text>
              <text wx:if="{{!player.is_alive}}" class="player-status-dead">
                {{utils.getDeathReason(player.death_reason)}}
              </text>
            </view>
          </view>
        </block>
      </view>
      <view class="section-title">æ¸¸æˆæ—¶é—´çº¿</view>
      <view class="timeline-content">
        <block wx:for="{{record.timeline}}" wx:for-item="event" wx:key="index">
          <view class="timeline-item">
            <text class="timeline-time">
              ç¬¬{{event.day}}å¤© {{event.phase === 'night' ? 'å¤œæ™š' : 'ç™½å¤©'}}
            </text>
            <text class="timeline-text">{{event.text}}</text>
            <!-- View Button -->
            <view wx:if="{{event.relatedVotingRound}}" bindtap="openVotingModal" data-round="{{event.relatedVotingRound}}" style="font-size: 24rpx; color: #ffd700; text-decoration: underline; margin-top: 10rpx;">
              æŸ¥çœ‹å½’ç¥¨å›¾
            </view>
          </view>
        </block>
        <view wx:if="{{!record.timeline || record.timeline.length === 0}}" class="empty-timeline">
          æš‚æ— æ—¶é—´çº¿è®°å½•
        </view>
      </view>
    </view>
  </block>
  <block wx:else>
    <view class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </block>
  <!-- å½’ç¥¨å›¾å¼¹çª— -->
  <view class="vote-modal {{showVotingModal ? 'show' : ''}}">
    <view class="vote-modal-content">
      <view class="vote-modal-header">
        <text>ğŸ“Š å½’ç¥¨è¯¦æƒ…</text>
        <view class="close-btn" bindtap="closeVotingModal">Ã—</view>
      </view>
      <scroll-view scroll-y class="vote-modal-body" wx:if="{{currentSelectedVotingRound}}">
        <view class="voting-round-title" style="text-align: center; color: #888; font-size: 24rpx; margin-bottom: 20rpx;">
          {{currentSelectedVotingRound.phase === 'sheriff_election' ? 'è­¦é•¿ç«é€‰' : (currentSelectedVotingRound.phase === 'day_pk' ? 'PKå¹³ç¥¨' : 'æ”¾é€æŠ•ç¥¨')}}
        </view>
        <block wx:for="{{currentSelectedVotingRound.enrichedVotes}}" wx:for-item="group" wx:key="targetSeat">
          <view class="vote-row" style="background: rgba(255,255,255,0.05); padding: 15rpx; margin-bottom: 10rpx; display: flex; justify-content: space-between; align-items: stretch; border-radius: 8rpx;">
            <!-- Voters -->
            <view class="voters-list" style="display: flex; flex-wrap: wrap; gap: 8rpx; flex: 1;">
              <block wx:for="{{group.voters}}" wx:for-item="voter" wx:key="seat">
                <view class="player-mini" style="display: flex; flex-direction: column; align-items: center; margin-right: 10rpx;">
                  <image class="avatar-mini" src="{{voter.avatar}}" style="width: 60rpx; height: 60rpx; border-radius: 50%; border: 1px solid #444;"></image>
                  <text class="seat-mini" style="font-size: 20rpx; color: #aaa;">
                    {{voter.seat}}å·
                  </text>
                  <text class="name-mini" style="font-size: 16rpx; color: #666; max-width: 80rpx; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{voter.nickname}}
                  </text>
                </view>
              </block>
            </view>
            <!-- Arrow -->
            <view class="vote-arrow-box" style="display: flex; align-items: center; padding: 0 15rpx;">
              <text class="vote-arrow-icon" style="font-size: 28rpx; color: #666;">â”</text>
            </view>
            <!-- Target -->
            <view class="player-mini" style="display: flex; flex-direction: column; align-items: center; align-self: center;">
              <block wx:if="{{!group.isAbstain}}">
                <image class="avatar-mini target-border" src="{{group.targetAvatar}}" style="width: 70rpx; height: 70rpx; border-radius: 50%; border: 2rpx solid #ffd700;"></image>
                <text class="seat-mini target-text" style="font-size: 24rpx; color: #ffd700;">
                  {{group.targetSeat}}å·
                </text>
                <text class="name-mini" style="font-size: 20rpx; color: #ccad00; margin-top: 4rpx; max-width: 100rpx; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{group.targetName}}
                </text>
              </block>
              <block wx:else>
                <view class="abstain-box" style="background: #333; color: #aaa; padding: 10rpx 20rpx; border-radius: 8rpx; font-size: 24rpx;">
                  å¼ƒ
                </view>
              </block>
            </view>
          </view>
        </block>
      </scroll-view>
      <button type="primary" style="width: 80%; border-radius: 50rpx; margin-top: 30rpx;" bindtap="closeVotingModal">
        å…³é—­
      </button>
    </view>
  </view>
</view>
<wxs module="utils">
module.exports.getKeys = function(obj) {
  if (!obj) return [];
  return Object.keys(obj).sort(function(a, b) { return parseInt(a) - parseInt(b); });
}
module.exports.getRoleName = function(role) {
  var map = {
    'werewolf': 'ç‹¼äºº',
    'villager': 'æ‘æ°‘',
    'seer': 'é¢„è¨€å®¶',
    'witch': 'å¥³å·«',
    'hunter': 'çŒäºº',
    'idiot': 'ç™½ç—´',
    'guard': 'å®ˆå«',
    'cupid': 'ä¸˜æ¯”ç‰¹',
    'unknown': 'éšè—'
  };
  return map[role] || role;
}
module.exports.getDeathReason = function(reason) {
  var map = {
    'kill': 'ç‹¼äººè¢­å‡»',
    'poison': 'å¥³å·«æ¯’æ€',
    'hunter_shoot': 'çŒäººå¸¦èµ°',
    'love': 'æƒ…ä¾£æ®‰æƒ…',
    'milk': 'å¥¶ç©¿(åŒå®ˆåŒæ•‘)',
    'vote': 'æŠ•ç¥¨æ”¾é€'
  };
  if (!reason) return 'å‡ºå±€';
  return map[reason] || reason || 'ä¸æ˜åŸå› ';
}
</wxs>