<!-- pages/usercenter/usercenter.wxml -->
<wxs module="tools">
  module.exports.formatTime = function(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    var m = date.getMonth() + 1;
    var d = date.getDate();
    var h = date.getHours();
    var min = date.getMinutes();
    if (min < 10) min = '0' + min;
    return m + 'æœˆ' + d + 'æ—¥ ' + h + ':' + min;
  }
</wxs>

<view class="container">
  <!-- é¡¶éƒ¨èƒŒæ™¯å±‚ -->
  <view class="bg-layer"></view>

  <view class="content-wrapper">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <view class="profile-header" bindtap="onEditProfile">
      <image class="avatar" src="{{userInfo.avatarUrl || '../../images/icons/avatar.png'}}" mode="aspectFill"></image>
      <view class="profile-text">
        <text class="nickname">{{userInfo.nickName || 'ç‚¹å‡»ç™»å½•/æ³¨å†Œ'}}</text>
        <view class="user-badge">ç‹¼äººæ€çˆ±å¥½è€…</view>
      </view>
      <view class="edit-btn">è®¾ç½® ></view>
    </view>

    <!-- æ•°æ®æ‚¬æµ®å¡ç‰‡ -->
    <view class="stats-card">
      <view class="stat-box">
        <text class="stat-val">{{stats.total || 0}}</text>
        <text class="stat-key">æ€»å±€æ•°</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-box">
        <text class="stat-val">{{stats.wins || 0}}</text>
        <text class="stat-key">èƒœåœº</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-box">
        <text class="stat-val accent">{{stats.winRate || '0%'}}</text>
        <text class="stat-key">èƒœç‡</text>
      </view>
    </view>

    <!-- æœ€è¿‘æˆ˜ç»© -->
    <view class="section-header" wx:if="{{recentRecord}}">
      <text class="section-title">æœ€è¿‘æˆ˜ç»©</text>
      <text class="section-more" bindtap="onTapMenuItem" data-path="/pages/records/records">å…¨éƒ¨ ></text>
    </view>
    
    <view class="record-card" wx:if="{{recentRecord}}" bindtap="onTapRecent">
      <view class="record-left">
        <view class="role-icon-box {{recentRecord.winner === 'good' ? 'win' : 'lose'}}">
           <text>{{recentRecord.winner === 'good' ? 'ğŸŒ•' : 'ğŸº'}}</text>
        </view>
        <view class="record-info">
          <text class="record-res">{{recentRecord.winner === 'good' ? 'å¥½äººé˜µè¥èƒœåˆ©' : 'ç‹¼äººé˜µè¥èƒœåˆ©'}}</text>
          <text class="record-date">{{tools.formatTime(recentRecord.game_start_time)}}</text>
        </view>
      </view>
      <view class="record-right">
        <text class="detail-btn">å¤ç›˜</text>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• (Grid) -->
    <view class="section-header">
      <text class="section-title">åŠŸèƒ½æœåŠ¡</text>
    </view>
    <view class="menu-grid">
      <view class="menu-card" bindtap="onTapMenuItem" data-path="/pages/records/records">
        <view class="menu-icon-bg" style="background: rgba(24, 144, 255, 0.15); color: #1890ff;">ğŸ“œ</view>
        <text class="menu-text">å†å²è®°å½•</text>
      </view>
      <view class="menu-card" bindtap="onTapMenuItem" data-path="/pages/rules/rules">
        <view class="menu-icon-bg" style="background: rgba(82, 196, 26, 0.15); color: #52c41a;">ğŸ“–</view>
        <text class="menu-text">æ¸¸æˆè§„åˆ™</text>
      </view>
      <view class="menu-card" bindtap="onTapMenuItem" data-type="feedback">
        <view class="menu-icon-bg" style="background: rgba(250, 173, 20, 0.15); color: #faad14;">ğŸ’¬</view>
        <text class="menu-text">æ„è§åé¦ˆ</text>
      </view>
    </view>
  </view>

  <view class="footer-info">Wolf Action v1.2.0</view>
</view>

<!-- ä¿®æ”¹ä¿¡æ¯å¼¹çª— -->
<view class="edit-modal" wx:if="{{showEditModal}}">
  <view class="modal-mask" bindtap="closeEditModal"></view>
  <view class="modal-content">
    <view class="modal-header">ä¿®æ”¹ä¸ªäººä¿¡æ¯</view>
    
    <button class="avatar-wrapper" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
      <image class="avatar-preview" src="{{tempAvatarUrl || userInfo.avatarUrl || '../../images/icons/avatar.png'}}"></image>
      <view class="avatar-tip">ç‚¹å‡»ä¿®æ”¹å¤´åƒ</view>
    </button> 
    
    <view class="input-section">
      <text class="input-label">æ˜µç§°</text>
      <input type="nickname" class="nickname-input" placeholder="è¯·è¾“å…¥æ–°æ˜µç§°" value="{{tempNickname || userInfo.nickName}}" bindinput="onNicknameChange" bindchange="onNicknameChange" bindblur="onNicknameChange" />
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeEditModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="saveProfile" loading="{{saveLoading}}">ä¿å­˜</button>
    </view>
  </view>
</view>
