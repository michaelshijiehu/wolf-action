<!-- pages/room/room.wxml -->
<wxs module="utils">
module.exports.jsonStringify = function(obj) {
  return JSON.stringify(obj, null, 2);
}
module.exports.getSeatStyle = function(index, total, isTheaterMode) {
  var angle = (360 / total) * index;
  var radius = isTheaterMode ? '450rpx' : '280rpx';
  return 'transform: rotate(' + angle + 'deg) translateY(-' + radius + ') rotate(-' + angle + 'deg);';
}
// è§’è‰²æ±‰åŒ–å‡½æ•°
module.exports.getRoleName = function(role) {
  var map = {
    'werewolf': 'ç‹¼äºº',
    'villager': 'æ‘æ°‘',
    'seer': 'é¢„è¨€å®¶',
    'witch': 'å¥³å·«',
    'hunter': 'çŒäºº',
    'idiot': 'ç™½ç—´',
    'guard': 'å®ˆå«',
    'cupid': 'ä¸˜æ¯”ç‰¹',
    'knight': 'éª‘å£«',
    'bear': 'ç†Š',
    'merchant': 'é»‘å•†',
    'silencer': 'ç¦è¨€é•¿è€',
    'gravekeeper': 'å®ˆå¢“äºº',
    'magician': 'é­”æœ¯å¸ˆ',
    'dream_catcher': 'æ‘„æ¢¦äºº',
    'wolf_king': 'ç™½ç‹¼ç‹',
    'wolf_beauty': 'ç‹¼ç¾äºº',
    'hidden_wolf': 'éšç‹¼',
    'gargoyle': 'çŸ³åƒé¬¼',
    'wild_child': 'é‡å­©å­',
    'bomberman': 'ç‚¸å¼¹äºº',
    'judge': 'æ³•å®˜',
    'unknown': 'éšè—'
  };
  return map[role] || role;
}
// åˆ¤æ–­æ˜¯å¦è¢«ç‹¼äººé€‰ä¸­
module.exports.isTargetedByWolves = function(votes, seat) {
  if (!votes) return false;
  var keys = Object.keys(votes);
  for (var i = 0; i < keys.length; i++) {
    if (votes[keys[i]] == seat) return true;
  }
  return false;
}
// é¢„è¨€å®¶è·å–æŸ¥éªŒç»“æœ
module.exports.getCheckResult = function(history, seat) {
  if (!history) return null;
  for (var i = 0; i < history.length; i++) {
    if (history[i].seat === seat) return history[i].isBad ? 'bad' : 'good';
  }
  return null;
}
// ä»é˜¶æ®µåæå–è§’è‰² Key
module.exports.getPhaseRole = function(phase) {
  if (!phase) return '';
  if (phase.indexOf('werewolf') !== -1) return 'werewolf';
  if (phase.indexOf('seer') !== -1) return 'seer';
  if (phase.indexOf('witch') !== -1) return 'witch';
  if (phase.indexOf('hunter') !== -1) return 'hunter';
  if (phase.indexOf('guard') !== -1) return 'guard';
  if (phase.indexOf('cupid') !== -1) return 'cupid';
  if (phase.indexOf('idiot') !== -1) return 'idiot';
  return '';
}
module.exports.getPhaseIcon = function(phase) {
  var role = module.exports.getPhaseRole(phase);
  if (role) return '../../images/roles/' + role + '.png';
  return '';
}
module.exports.formatCandidateList = function(seats) {
  if (!seats || seats.length === 0) return 'æš‚æ— ';
  var list = [];
  for (var i = 0; i < seats.length; i++) {
    if (seats[i] && seats[i] > 0) list.push(seats[i]);
  }
  if (list.length === 0) return 'æš‚æ— ';
  list.sort(function(a, b) { return a - b; });
  return list.join(', ') + 'å·';
}
module.exports.isNominee = function(candidates, seat) {
  if (!candidates || !candidates.length) return false;
  return candidates.indexOf(seat) !== -1;
}
</wxs>
<view class="not-found-container" wx:if="{{roomNotFound}}">
  <image class="not-found-icon" src="../../images/icons/close.png" style="width: 120rpx; height: 120rpx; opacity: 0.5; margin-bottom: 20rpx; filter: grayscale(100%);"></image>
  <view class="not-found-text">æˆ¿é—´ä¸å­˜åœ¨æˆ–å·²è§£æ•£</view>
  <button class="primary-btn" bindtap="onBackHome" style="margin-top: 40rpx; width: 40%;">
    è¿”å›å¤§å…
  </button>
</view>
<view class="container {{(!gameState || gameState.game_state.status === 'waiting' || gameState.game_state.phase !== 'night' || gameState.game_state.sub_phase === 'night_start') ? 'day-mode' : ''}} {{((isJudge || isCreator) && gameState.game_state.status === 'playing') ? 'with-judge-panel' : ''}}" wx:if="{{!loading && !roomNotFound}}">
  <view class="header">
    <view class="room-id">
      æˆ¿é—´å·: {{roomId}}
      <button size="mini" class="copy-btn" wx:if="{{gameState.game_state.status === 'waiting'}}" bindtap="onCopyRoomId">
        å¤åˆ¶
      </button>
    </view>
    <view class="game-time" wx:if="{{gameDuration}}" style="font-weight: bold; color: #ffd700; font-size: 28rpx; background: rgba(0,0,0,0.3); padding: 4rpx 16rpx; border-radius: 10rpx;">
      â±ï¸ {{gameDuration}}
    </view>
  </view>
  <view class="subtitle-overlay" wx:if="{{audioText}}">
    <text>{{audioText}}</text>
  </view>
  <!-- å¯æ‹–æ‹½åœ†æ¡ŒåŒºåŸŸ -->
  <movable-area class="table-drag-area {{isTheaterMode ? 'full' : ''}}">
    <movable-view class="table-movable-view {{isTheaterMode ? 'theater' : ''}}" direction="all" inertia out-of-bounds friction="1" damping="20" scale scale-min="0.5" scale-max="2" x="{{isTheaterMode ? -150 : 0}}" y="0">
      <view class="table-container {{(gameState.game_state.status === 'waiting' || gameState.game_state.phase !== 'night' || gameState.game_state.sub_phase === 'night_start') ? 'day' : ''}}">
        <view class="table-center">
          <!-- æ¢å¤æ¡Œé¢ä¸­å¿ƒçŠ¶æ€æ˜¾ç¤º -->
          <view class="center-status-container" wx:if="{{gameState.game_state.status === 'playing'}}">
            <view class="phase-text" style="margin-bottom: 20rpx;">
              {{gameState.game_state.current_instruction.title}}
            </view>
            <!-- ä½¿ç”¨æ­£ç¡®åŒ¹é… CSS çš„ timer æ ·å¼ -->
            <view class="timer-circle" wx:if="{{countdown > 0}}">
              <text class="timer-num">{{countdown}}</text>
            </view>
          </view>
          <view class="voice-limit-tip" wx:if="{{ttsStatus === 'limit_reached'}}">
            âš ï¸ è¯­éŸ³é¢åº¦è€—å°½ï¼Œè¯·æ£€æŸ¥ç™¾åº¦äº‘åå°
          </view>
        </view>
        <view class="seats-wrapper">
          <block wx:for="{{gameState.players}}" wx:key="seat">
            <view class="seat-item {{!item.is_alive ? 'dead' : ''}}" style="{{utils.getSeatStyle(index, gameState.players.length, isTheaterMode)}}" bindtap="onSeatTap" data-seat="{{item.seat}}" data-occupied="{{!!item.openid}}">
              <view class="avatar-box {{mySeat === item.seat ? 'me' : ''}}">
                <image class="avatar-img" src="{{item.avatar_url}}" wx:if="{{item.avatar_url}}"></image>
                <view class="avatar-empty" wx:else>{{item.seat}}</view>
                <!-- åº§ä½å·æ ‡è¯† (æœ‰å¤´åƒæ—¶æ˜¾ç¤º) -->
                <view class="seat-badge" wx:if="{{item.avatar_url}}">{{item.seat}}</view>
                <!-- èº«ä»½æ ‡è¯†ï¼šä»…åœ¨æ¸¸æˆå¼€å§‹åæ˜¾ç¤ºï¼Œä¸”éœ€æ»¡è¶³æƒé™ -->
                <view class="role-badge" wx:if="{{gameState.game_state.status === 'playing' && (isJudge || (item.role === 'idiot' && item.role_state.idiot_revealed))}}">
                  {{utils.getRoleName(item.role)}}
                </view>
                <!-- è­¦å¾½æ ‡å¿— -->
                <view class="sheriff-badge" wx:if="{{gameState.game_state.sheriff_seat === item.seat}}">
                  ğŸ‘®
                </view>
                <!-- ä¸Šè­¦ä¸¾æ‰‹æ ‡å¿— -->
                <view class="hand-raise-badge" wx:if="{{utils.isNominee(gameState.game_state.sheriff_candidate_seats, item.seat)}}">
                  âœ‹
                </view>
                <!-- é¢„è¨€å®¶å†å²æŸ¥éªŒæ ‡è®° (ä»…é¢„è¨€å®¶æœ¬äººå¯è§) -->
                <view class="check-mark" wx:if="{{myRole === 'seer' && utils.getCheckResult(myRoleState.check_history, item.seat)}}">
                  {{utils.getCheckResult(myRoleState.check_history, item.seat) === 'bad' ? 'ğŸŒ‘' : 'ğŸŒ•'}}
                </view>
                <image class="death-icon" wx:if="{{!item.is_alive}}" src="../../images/icons/close.png"></image>
                <!-- æ­»äº¡åŸå› æ ‡è®° (ä»…æ³•å®˜æˆ–æ­»è€…æœ¬äººæˆ–ç™½å¤©ç»“ç®—åå¯è§) -->
                <view class="death-reason-mark" wx:if="{{!item.is_alive && item.death_reason === 'werewolf_kill'}}" title="è¢«åˆ€">
                  ğŸ”ª
                </view>
                <!-- ç‹¼äººç›®æ ‡æ ‡è®° (ç‹¼äººæˆ–æ³•å®˜å¯è§) -->
                <view class="target-mark" wx:if="{{(myRole === 'werewolf' || isJudge) && utils.isTargetedByWolves(gameState.current_round_actions.werewolf_votes, item.seat)}}">
                  ğŸ¯
                </view>
                <!-- é¢„è¨€å®¶æŸ¥éªŒç›®æ ‡ (æ³•å®˜å¯è§) -->
                <view class="seer-mark-judge" wx:if="{{isJudge && gameState.current_round_actions.seer_check.target === item.seat}}">
                  ğŸ”®
                </view>
                <!-- å®ˆå«å®ˆæŠ¤ç›®æ ‡ (æ³•å®˜å¯è§) -->
                <view class="guard-mark-judge" wx:if="{{isJudge && gameState.current_round_actions.guard_protect === item.seat}}">
                  ğŸ›¡ï¸
                </view>
                <!-- å¥³å·«ç”¨è¯ç›®æ ‡ (æ³•å®˜å¯è§) -->
                <view class="poison-mark" wx:if="{{(witchPoisonTarget == item.seat) || (isJudge && gameState.current_round_actions.witch_action.poison_target === item.seat)}}">
                  â˜ ï¸
                </view>
                <view class="save-mark-judge" wx:if="{{isJudge && gameState.current_round_actions.witch_action.save && (wolfKillTarget && wolfKillTarget.seat === item.seat)}}">
                  ğŸ¼
                </view>
                <!-- New: Witch View - Kill Target -->
                <view class="witch-kill-indicator" wx:if="{{myRole === 'witch' && gameState.game_state.sub_phase === 'witch_action' && witchKillTarget === item.seat}}" style="position: absolute; top: -10rpx; left: 50%; transform: translateX(-50%); background: #ff4d4f; color: #fff; font-size: 20rpx; padding: 2rpx 12rpx; border-radius: 10rpx; font-weight: bold; z-index: 100; box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.5); white-space: nowrap;">
                  ğŸš¨ æ˜¨æ™šè¢«æ€
                </view>
                <!-- æƒ…ä¾£æ ‡å¿— (ä»…æ³•å®˜å¯è§ï¼Œç©å®¶ç§»åŠ¨åˆ°èº«ä»½å¡å†…) -->
                <view class="lover-badge" wx:if="{{isJudge && gameState.game_state.lovers.includes(item.seat)}}">
                  â¤ï¸
                </view>
                <!-- ä¸˜æ¯”ç‰¹è¿äººç›®æ ‡æ ‡è®° (æ³•å®˜å¯è§æˆ–æ­£åœ¨è¿æ¥ä¸­) -->
                <view class="target-mark" style="color: #ff85c0;" wx:if="{{(gameState.game_state.sub_phase === 'cupid_action' && cupidTargets.includes(item.seat))}}">
                  ğŸ’
                </view>
                <!-- ç™½ç—´ç¿»ç‰Œæ ‡å¿— -->
                <view class="idiot-badge" wx:if="{{item.role === 'idiot' && item.role_state.idiot_revealed}}">
                  ğŸ­
                </view>
                <!-- Judge: Real-time Vote Monitor -->
                <view class="judge-vote-indicator" wx:if="{{isJudge && (gameState.game_state.phase === 'day_voting' || gameState.game_state.phase === 'day_pk') && gameState.current_round_actions.day_votes[item.seat]}}">
                  ğŸ—³ï¸ {{gameState.current_round_actions.day_votes[item.seat]}}
                </view>
                <!-- Mark indicator -->
                <view wx:if="{{ playerMarks[item.seat] }}" class="player-mark-indicator {{playerMarks[item.seat].value}}">
                  <text>{{ playerMarks[item.seat].label }}</text>
                </view>
              </view>
              <view class="seat-name">{{item.nickname}}</view>
            </view>
          </block>
        </view>
      </view>
    </movable-view>
  </movable-area>
  <!-- æ¸¸æˆè¾…åŠ©ä¿¡æ¯åŒº (ä»…ä¿ç•™æ–¹æ¡ˆ 1) -->
  <view class="game-extra-info" wx:if="{{gameState.game_state.status === 'playing'}}">
    <!-- æ–¹æ¡ˆ 1: åŠ¨æ€äº‹ä»¶ç®€è®¯ -->
    <view class="event-ticker" wx:if="{{tickerLogs.length > 0}}">
      <view class="ticker-item" wx:for="{{tickerLogs}}" wx:key="index">
        <view class="ticker-time">[{{item.day}}å¤©]</view>
        <view class="ticker-text">{{item.text}}</view>
      </view>
    </view>
  </view>
  <!-- 1. ç­‰å¾…é˜¶æ®µï¼šé…ç½®é¢æ¿ -->
  <!-- 1. ç­‰å¾…é˜¶æ®µï¼šé…ç½®é¢æ¿ -->
  <!-- 1. ç­‰å¾…é˜¶æ®µï¼šé…ç½®é¢æ¿ -->
  <view class="setup-area" wx:if="{{gameState.game_state.status === 'waiting'}}">
    <view class="setup-card">
      <view class="header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx;">
        <view class="count-tip">å·²å…¥åº§: {{currentCount}} / {{gameState.players.length}}</view>
        <view class="room-capacity" style="font-size: 24rpx; color: #888;">
          {{gameState.players.length}}äººå±€
        </view>
      </view>
      <!-- Sitting Hint -->
      <view class="sitting-hint-card" wx:if="{{!mySeat}}" style="background: rgba(24, 144, 255, 0.1); border: 1rpx dashed #1890ff; padding: 16rpx; border-radius: 12rpx; margin-bottom: 24rpx; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
        <text style="color: #1890ff; font-size: 26rpx; font-weight: bold;">ğŸ‘‰ è¯·ç‚¹å‡»åœ†æ¡Œä¸Šçš„ç©ºåº§ä½å…¥åº§</text>
      </view>
      <!-- é…ç½®æ¦‚è§ˆ (ç‚¹å‡»å‰å¾€è®¾ç½®é¡µ) -->
      <view class="config-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12rpx; padding: 0 4rpx;">
        <view style="font-size: 24rpx; color: rgba(255,255,255,0.4); font-weight: bold; text-transform: uppercase; letter-spacing: 2rpx;">
          è§’è‰²é…ç½®
        </view>
        <view style="font-size: 22rpx; color: #ffd700; opacity: 0.8;" wx:if="{{activeGodsText}}">
          ç¥èŒ: {{activeGodsText}}
        </view>
      </view>
      <view class="config-grid clickable" bindtap="goToSetup">
        <view class="config-item">ğŸº ç‹¼äºº: {{tempConfig.werewolf}}</view>
        <view class="config-item">ğŸ§‘â€ğŸŒ¾ æ‘æ°‘: {{tempConfig.villager}}</view>
        <view class="config-item">
          ğŸ”® ç¥èŒ: {{configTotal - tempConfig.werewolf - tempConfig.villager}}
        </view>
        <view class="arrow-right">></view>
      </view>
      <view class="lobby-action-row" style="display: flex; gap: 16rpx; margin-bottom: 24rpx;">
        <button class="primary-btn" bindtap="onStartGame" style="flex: 1; margin-bottom: 0;">
          å¼€å§‹æ¸¸æˆ
        </button>
        <button class="secondary-btn" bindtap="onSeatTap" data-seat="{{mySeat}}" data-occupied="{{true}}" style="width: 220rpx; background: rgba(255,255,255,0.1); color: #fff;" wx:if="{{mySeat}}">
          æ‹…ä»»æ³•å®˜
        </button>
      </view>
      <!-- è‡ªåŠ¨åŒ–æµ‹è¯•åŠŸèƒ½ -->
      <view class="lobby-footer" style="display: flex; align-items: center; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 24rpx;">
        <view class="manual-test-switch" style="display: flex; align-items: center;">
          <text style="color: #888; font-size: 24rpx; margin-right: 10rpx;">æ‰‹åŠ¨æµ‹è¯•</text>
          <switch checked="{{manualTestMode}}" bindchange="onManualTestChange" color="#faad14" style="transform: scale(0.7);" />
        </view>
        <button size="mini" class="auto-fill-btn" bindtap="onAutoTest" style="margin: 0; background: rgba(24adb3, 0.2); color: #faad14; border: 1rpx solid #faad14;">
          ğŸ¤– å¡«å……æœºå™¨äºº
        </button>
      </view>
    </view>
  </view>
  <!-- æ¸¸æˆé…ç½®å±•ç¤º (ä»…ç©å®¶å¯è§) -->
  <view class="game-config-info" wx:if="{{gameState.game_state.status === 'playing' && !isJudge}}">
    <view class="config-tag">ğŸº {{gameState.config.roles.werewolf}}</view>
    <view class="config-tag">ğŸ§‘â€ğŸŒ¾ {{gameState.config.roles.villager}}</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.seer}}">ğŸ”®</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.witch}}">ğŸ§ª</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.hunter}}">ğŸ”«</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.idiot}}">ğŸ¤¤</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.guard}}">ğŸ›¡ï¸</view>
    <view class="config-tag" wx:if="{{gameState.config.roles.cupid}}">ğŸ’˜</view>
  </view>
  <!-- æ¸¸æˆè¡ŒåŠ¨æ“ä½œåŒºåŸŸ -->
  <view class="action-area" wx:if="{{gameState.game_state.status === 'playing'}}">
    <!-- 1. é¢„è¨€å®¶ä¸“æœ‰é¢æ¿ -->
    <view class="witch-panel" wx:if="{{gameState.game_state.current_instruction.actionPanel === 'seer' && myRole === 'seer'}}">
      <view class="witch-card" style="border-color: #1890ff;">
        <view class="panel-title" style="color: #1890ff;">é¢„è¨€å®¶è¯·è¡ŒåŠ¨</view>
        <view class="tips">è¯·ç‚¹å‡»å¤´åƒé€‰æ‹©æŸ¥éªŒç›®æ ‡</view>
        <view class="seer-result" wx:if="{{myRoleState.check_history.length > 0}}">
          <view class="section-label">æŸ¥éªŒè®°å½•:</view>
          <view wx:for="{{myRoleState.check_history}}" wx:key="seat" style="font-size: 24rpx; color: #fff;">
            {{item.seat}}å·: {{item.isBad ? 'é»‘äºº (ç‹¼äºº) ğŸŒ‘' : 'ç™½äºº (å¥½äºº) ğŸŒ•'}}
          </view>
        </view>
        <button class="skip-btn" bindtap="onConfirmAction" wx:if="{{isMyTurn}}">
          ç¡®å®š/ç©ºéªŒ {{actionCountdown > 0 ? '(' + actionCountdown + 's)' : ''}}
        </button>
      </view>
    </view>
    <!-- 2. å®ˆå«ä¸“æœ‰é¢æ¿ -->
    <view class="witch-panel" wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'guard' && myRole === 'guard'}}">
      <view class="witch-card" style="border-color: #52c41a;">
        <view class="panel-title" style="color: #52c41a;">å®ˆå«è¯·è¡ŒåŠ¨</view>
        <view class="tips">è¯·é€‰æ‹©å®ˆæŠ¤ç›®æ ‡ï¼Œä¸èƒ½è¿ç»­å®ˆæŠ¤åŒä¸€äºº</view>
        <view class="vote-status" style="margin-bottom: 20rpx; color: #ccc; font-size: 24rpx;">
          <text wx:if="{{myRoleState.guard_last_protected_seat}}">
            ä¸Šè½®å®ˆæŠ¤: {{myRoleState.guard_last_protected_seat}}å·
          </text>
          <text wx:else>ä¸Šè½®æœªè¿›è¡Œå®ˆæŠ¤</text>
        </view>
        <button class="skip-btn" bindtap="onConfirmAction" wx:if="{{isMyTurn}}">
          ç¡®å®š/ç©ºå®ˆ {{actionCountdown > 0 ? '(' + actionCountdown + 's)' : ''}}
        </button>
      </view>
    </view>
    <!-- 3. å¥³å·«ä¸“æœ‰é¢æ¿ -->
    <view class="witch-panel" wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'witch' && myRole === 'witch'}}">
      <view class="witch-card" style="border-color: #722ed1;">
        <view class="panel-title" style="color: #722ed1;">å¥³å·«è¯·è¡ŒåŠ¨</view>
        <view class="witch-action-row" style="display: flex; justify-content: space-between; width: 100%; gap: 16rpx; margin-bottom: 12rpx;">
          <view class="panel-header-row" style="margin-top:20rpx; border-top:1rpx solid rgba(255,255,255,0.1); paddingTop:10rpx;">
            <view style="display:flex; gap:20rpx; align-items:center; flex-wrap:wrap;">
              <!-- Bot Fill -->
              <button size="mini" bindtap="onAutoTest" style="background:#1890ff; color:#fff; font-size:24rpx; padding: 0 16rpx;">
                ğŸ¤– å¡«å……Bot
              </button>
              <!-- Manual Toggle -->
              <button size="mini" bindtap="toggleManualMode" style="background:{{isManualMode ? '#faad14' : '#52c41a'}}; color:#fff; font-size:24rpx; padding: 0 16rpx;">
                {{isManualMode ? 'ğŸ› ï¸ æ‰‹åŠ¨æ­¥è¿›' : 'ğŸš€ è‡ªåŠ¨æµè½¬'}}
              </button>
              <!-- Next Step (Only visible in Manual Mode) -->
              <button size="mini" bindtap="onDevSimulate" wx:if="{{isManualMode}}" style="background:#722ed1; color:#fff; font-size:24rpx; padding: 0 16rpx;">
                â–¶ï¸ ä¸‹ä¸€æ­¥
              </button>
              <button size="mini" bindtap="toggleGodView" style="background:#595959; color:#fff; font-size:24rpx; padding: 0 16rpx;">
                ğŸ‘ï¸ ä¸Šå¸è§†è§’
              </button>
              <!-- Run Tests -->
              <button size="mini" bindtap="onRunTests" style="background:#ff4d4f; color:#fff; font-size:24rpx; padding: 0 16rpx;">
                ğŸ§ª è¿è¡Œæµ‹è¯•
              </button>
            </view>
          </view>
          <!-- è§£è¯ -->
          <view class="potion-section" style="flex: 1; background: rgba(255,255,255,0.05); padding: 12rpx; border-radius: 10rpx; display: flex; flex-direction: column; align-items: center;">
            <view class="section-label" style="font-weight: bold; color: #aaa; font-size: 24rpx;">
              è§£è¯
            </view>
            <block wx:if="{{!myRoleState.witch_save_used}}">
              <view class="victim-info" wx:if="{{wolfKillTarget}}" style="font-size: 22rpx; color: #ff4d4f;">
                {{wolfKillTarget.seat}}å· è¢«åˆ€
              </view>
              <view wx:else style="font-size: 22rpx; color: #52c41a;">å¹³å®‰å¤œ</view>
              <button size="mini" type="primary" disabled="{{!wolfKillTarget}}" bindtap="onWitchSave" style="font-size: 22rpx; margin-top: 5rpx;" wx:if="{{isMyTurn}}">
                ä½¿ç”¨
              </button>
            </block>
            <text wx:else style="color: #666; font-size: 22rpx;">å·²ä½¿ç”¨</text>
          </view>
          <!-- æ¯’è¯ -->
          <view class="potion-section" style="flex: 1; background: rgba(255,255,255,0.05); padding: 12rpx; border-radius: 10rpx; display: flex; flex-direction: column; align-items: center;">
            <view class="section-label" style="font-weight: bold; color: #aaa; font-size: 24rpx;">
              æ¯’è¯
            </view>
            <block wx:if="{{!myRoleState.witch_poison_used}}">
              <text style="font-size: 20rpx; color: #aaa; text-align: center;">ç‚¹å‡»å¤´åƒ\né€‰æ‹©ç›®æ ‡</text>
              <text wx:if="{{witchPoisonTarget}}" style="color: #a0d911; font-size: 22rpx;">
                å·²é€‰ {{witchPoisonTarget}}å·
              </text>
            </block>
            <text wx:else style="color: #666; font-size: 22rpx;">å·²ä½¿ç”¨</text>
          </view>
        </view>
        <button class="skip-btn" bindtap="onConfirmAction" wx:if="{{isMyTurn}}">
          ç¡®å®š/ç»“æŸ {{actionCountdown > 0 ? '(' + actionCountdown + 's)' : ''}}
        </button>
      </view>
    </view>
    <!-- 4. è­¦é•¿ç«é€‰é¢æ¿ -->
    <view class="witch-panel" wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'sheriff_nomination' && !isJudge}}">
      <view class="witch-card" style="border-color: #ffd700;">
        <view class="panel-title" style="color: #ffd700;">è­¦é•¿ç«é€‰</view>
        <view class="tips" style="color: #888; font-size: 22rpx;">æƒ³è¦ç«é€‰è­¦é•¿çš„ç©å®¶è¯·ä¸Šè­¦</view>
        <view class="nominate-row" style="display: flex; gap: 20rpx; justify-content: center; margin: 16rpx 0;">
          <button 
            bindtap="onSheriffJoin" 
            data-join="{{!isSheriffCandidate}}" 
            type="{{isSheriffCandidate ? 'warn' : 'primary'}}" 
            size="mini"
            style="min-width: 200rpx; font-weight: bold; border-radius: 30rpx;">
            {{isSheriffCandidate ? 'ğŸ”™ é€€æ°´ (å·²ä¸Šè­¦)' : 'âœ‹ æˆ‘è¦ä¸Šè­¦'}}
          </button>
        </view>
        <view class="tips" style="font-size: 24rpx; color: #ffd700;">
          å½“å‰å€™é€‰: {{utils.formatCandidateList(gameState.game_state.sheriff_candidate_seats)}}
        </view>
      </view>
    </view>
    <!-- 5. é€šç”¨/å…¶ä»–è¡ŒåŠ¨é¢æ¿ (æŠ•ç¥¨, ç‹¼äºº, ä¸˜æ¯”ç‰¹, çŒäºº, ç§»äº¤è­¦å¾½ ç­‰) -->
    <view class="witch-panel" wx:elif="{{gameState.game_state.current_instruction.actionPanel !== 'none' && isMyTurn}}">
      <view class="witch-card" style="border-color: {{gameState.game_state.current_instruction.color || '#ffd700'}};">
        <view class="panel-title" style="color: {{gameState.game_state.current_instruction.color || '#ffd700'}};">
          {{gameState.game_state.current_instruction.title}}
        </view>
        <view class="tips" style="color: #888; font-size: 22rpx;">
          {{gameState.game_state.current_instruction.tips}}
        </view>
        <view class="vote-status" style="text-align: center; color: #ccc; font-size: 24rpx; margin-bottom: 12rpx;">
          <block wx:if="{{gameState.game_state.current_instruction.actionPanel === 'werewolf'}}">
            {{wolfConsensusTarget ? 'ğŸ”¥ é˜Ÿå‹é›†ç«: ' + wolfConsensusTarget + 'å·' : 'è¯·ä¸é˜Ÿå‹å•†è®®ç›®æ ‡'}}
          </block>
          <block wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'cupid'}}">
            å·²è¿: {{cupidTargets[0] || '?'}} & {{cupidTargets[1] || '?'}}
          </block>
          <block wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'vote_sheriff' || gameState.game_state.current_instruction.actionPanel === 'vote_exile' || gameState.game_state.current_instruction.actionPanel === 'pk_voting'}}">
            {{myVoteTarget ? 'æˆ‘çš„æŠ•ç¥¨: ' + myVoteTarget + 'å·' : 'è¯·ç‚¹å‡»æ‰€æŠ•ç©å®¶å¤´åƒ'}}
          </block>
          <block wx:elif="{{gameState.game_state.current_instruction.actionPanel === 'hunter_action' || gameState.game_state.current_instruction.actionPanel === 'hunter_confirm'}}">
            {{myRole === 'hunter' ? (gameState.game_state.current_instruction.actionPanel === 'hunter_confirm' ? 'æˆ‘çš„çŠ¶æ€: ' + (myRoleState.is_poisoned ? 'ä¸å¯å¼€æª' : 'å¯å¼€æª') : 'è¯·é€‰æ‹©å¸¦èµ°ç›®æ ‡') : 'è¯·ç­‰å¾…çŒäººè¡ŒåŠ¨'}}
          </block>
        </view>
        <button class="skip-btn" wx:if="{{gameState.game_state.current_instruction.actionBtn}}" bindtap="onConfirmAction">
          {{gameState.game_state.current_instruction.actionBtn}} {{actionCountdown > 0 ? '(' + actionCountdown + 's)' : ''}}
        </button>
      </view>
    </view>
  </view>
  <!-- ä¸Šå¸/æˆ¿ä¸»åº•éƒ¨é¢æ¿ (è¿˜åŸ) -->
  <view class="judge-panel" wx:if="{{(isJudge || isCreator) && gameState.game_state.status === 'playing'}}">
    <!-- ä¸Šå¸è§†é‡ï¼šç©å®¶èº«ä»½åˆ—è¡¨ (å¯æŠ˜å ) -->
    <view class="god-view-list" style="margin-bottom: 24rpx; background: rgba(255,255,255,0.03); border-radius: 16rpx; border: 1rpx solid rgba(255,255,255,0.05);">
      <view bindtap="toggleGodView" style="font-size: 20rpx; color: #888; padding: 12rpx; text-align: center; letter-spacing: 4rpx; border-bottom: {{showGodViewList ? '1rpx solid rgba(255,255,255,0.05)' : 'none'}};">
        {{showGodViewList ? 'â–¼ æ”¶èµ·å…¨åœºèº«ä»½' : 'â–¶ æŸ¥çœ‹å…¨åœºèº«ä»½'}}
      </view>
      <view class="god-player-grid" wx:if="{{showGodViewList}}" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10rpx; padding: 16rpx;">
        <block wx:for="{{gameState.players}}" wx:key="seat">
          <view class="god-player-item {{item.is_alive ? '' : 'god-dead'}}" style="display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.2); padding: 8rpx; border-radius: 8rpx; position: relative;">
            <view style="font-size: 18rpx; color: #666; margin-bottom: 4rpx;">{{item.seat}}</view>
            <view style="font-size: 22rpx; font-weight: bold; color: {{item.role === 'werewolf' ? '#ff4d4f' : (item.role === 'villager' ? '#eee' : '#ffd700')}}; opacity: {{item.is_alive ? 1 : 0.4}};">
              {{utils.getRoleName(item.role)}}
            </view>
            <view wx:if="{{!item.is_alive}}" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 20rpx; color: #ff4d4f; border-radius: 8rpx;">
              âœ•
            </view>
          </view>
        </block>
      </view>
    </view>
    <!-- Debug Actions Toolbar -->
    <view class="panel-header-row" style="margin-bottom: 20rpx; border-bottom: 1rpx solid rgba(255,255,255,0.05); padding-bottom: 16rpx;">
      <view style="display:flex; gap:16rpx; align-items:center; flex-wrap:wrap;">
        <button size="mini" bindtap="onAutoTest" style="background:#1890ff; color:#fff; font-size:24rpx; padding: 0 16rpx; margin:0;">
          ğŸ¤– å¡«å……Bot
        </button>
        <button size="mini" bindtap="toggleManualMode" style="background:{{isManualMode ? '#faad14' : '#52c41a'}}; color:#fff; font-size:24rpx; padding: 0 16rpx; margin:0;">
          {{isManualMode ? 'ğŸ› ï¸ æ‰‹åŠ¨' : 'ğŸš€ è‡ªåŠ¨'}}
        </button>
        <button size="mini" bindtap="onDevSimulate" wx:if="{{isManualMode}}" style="background:#722ed1; color:#fff; font-size:24rpx; padding: 0 16rpx; margin:0;">
          â–¶ï¸ ä¸‹ä¸€æ­¥
        </button>
      </view>
    </view>
    <view class="panel-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx; padding-bottom: 10rpx; border-bottom: 1rpx solid rgba(255,255,255,0.1);">
      <view style="font-size: 26rpx; color: #ffd700; font-weight: bold;">
        å½“å‰: {{gameState.game_state.current_instruction.title}}
      </view>
      <view style="display:flex; gap:24rpx; align-items: center;">
        <view catchtap="toggleLog" style="font-size:40rpx; padding: 10rpx; background: rgba(255,255,255,0.1); border-radius: 8rpx;">
          ğŸ“œ
        </view>
        <view catchtap="toggleTheaterMode" style="font-size:40rpx; padding: 10rpx; background: rgba(255,255,255,0.1); border-radius: 8rpx;">
          {{isTheaterMode ? 'ğŸ”³' : 'ğŸ”²'}}
        </view>
        <view catchtap="toggleRoleCard" style="font-size:40rpx; padding: 10rpx; background: rgba(255,255,255,0.1); border-radius: 8rpx;">
          ğŸ†”
        </view>
      </view>
    </view>
    <!-- 2. Action Summary (Night Only) -->
    <view class="judge-summary-box" wx:if="{{isJudge && judgeSummary}}" style="margin-bottom: 24rpx; background: rgba(0,0,0,0.2); padding: 16rpx; border-radius: 12rpx;">
      <!-- Wolf Section -->
      <view class="summary-section" style="margin-bottom: 16rpx;">
        <view style="font-size: 22rpx; color: #ff4d4f; margin-bottom: 12rpx; font-weight: bold; opacity: 0.8;">
          ç‹¼äººé˜µè¥
        </view>
        <view class="sum-prop" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16rpx;">
          <view class="sum-item">
            <text>ğŸ”ª å‡»æ€:</text>
            <text class="{{judgeSummary.wolfTarget ? '' : 'dim'}}">
              {{judgeSummary.wolfTarget ? judgeSummary.wolfTarget + 'å·' : 'æœªå®š'}}
            </text>
          </view>
          <view class="sum-item" wx:if="{{judgeSummary.wolf_beauty}}">
            <text>ğŸ’„ é­…æƒ‘:</text>
            <text class="{{judgeSummary.wolf_beauty.target ? '' : 'dim'}}">
              {{judgeSummary.wolf_beauty.target ? judgeSummary.wolf_beauty.target + 'å·' : 'æ— '}}
            </text>
          </view>
          <view class="sum-item" wx:if="{{judgeSummary.lovers.length > 0}}">
            <text>â¤ï¸ æƒ…ä¾£:</text>
            <text>{{judgeSummary.lovers[0]}} & {{judgeSummary.lovers[1]}}</text>
          </view>
        </view>
      </view>
      <!-- God Section -->
      <view class="summary-section">
        <view style="font-size: 22rpx; color: #ffd700; margin-bottom: 12rpx; font-weight: bold; opacity: 0.8;">
          ç¥èŒ/ç‰¹æ®Š
        </view>
        <view class="sum-prop" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16rpx;">
          <!-- é¢„è¨€å®¶ -->
          <view class="sum-item" wx:if="{{judgeSummary.seer}}">
            <text>ğŸ”® æŸ¥éªŒ:</text>
            <text class="{{judgeSummary.seer.target ? '' : 'dim'}}">
              {{judgeSummary.seer.target ? judgeSummary.seer.target + 'å·' : 'æœªéªŒ'}}
            </text>
            <text wx:if="{{judgeSummary.seer.target}}" style="margin-left:4rpx; color: {{judgeSummary.seer.isBad ? '#ff4d4f' : '#52c41a'}}">
              {{judgeSummary.seer.isBad ? '(ç‹¼)' : '(é‡‘)'}}
            </text>
          </view>
          <!-- å®ˆå« -->
          <view class="sum-item" wx:if="{{judgeSummary.guard}}">
            <text>ğŸ›¡ï¸ å®ˆå«:</text>
            <text class="{{judgeSummary.guard.target ? '' : 'dim'}}">
              {{judgeSummary.guard.target ? judgeSummary.guard.target + 'å·' : 'ç©ºå®ˆ'}}
            </text>
          </view>
          <!-- å¥³å·« -->
          <view class="sum-item" wx:if="{{judgeSummary.witch}}">
            <text>ğŸ’Š æ•‘è¯:</text>
            <text class="{{judgeSummary.witch.save ? 'active' : 'dim'}}">
              {{judgeSummary.witch.save ? 'å·²ç”¨' : 'æœªç”¨'}}
            </text>
          </view>
          <view class="sum-item" wx:if="{{judgeSummary.witch}}">
            <text>ğŸ§ª æ¯’è¯:</text>
            <text class="{{judgeSummary.witch.poison ? 'active' : 'dim'}}">
              {{judgeSummary.witch.poison ? judgeSummary.witch.poison + 'å·' : 'æœªç”¨'}}
            </text>
          </view>
          <!-- æ‘„æ¢¦äºº -->
          <view class="sum-item" wx:if="{{judgeSummary.dream_catcher}}">
            <text>ğŸ’¤ æ‘„æ¢¦:</text>
            <text class="{{judgeSummary.dream_catcher.target ? '' : 'dim'}}">
              {{judgeSummary.dream_catcher.target ? judgeSummary.dream_catcher.target + 'å·' : 'æ— '}}
            </text>
          </view>
          <!-- ç¦è¨€ -->
          <view class="sum-item" wx:if="{{judgeSummary.silencer}}">
            <text>ğŸ¤ ç¦è¨€:</text>
            <text class="{{judgeSummary.silencer.target ? '' : 'dim'}}">
              {{judgeSummary.silencer.target ? judgeSummary.silencer.target + 'å·' : 'æ— '}}
            </text>
          </view>
          <!-- é­”æœ¯å¸ˆ -->
          <view class="sum-item" wx:if="{{judgeSummary.magician}}">
            <text>ğŸ© äº¤æ¢:</text>
            <text class="{{judgeSummary.magician.targets ? '' : 'dim'}}">
              {{judgeSummary.magician.targets ? judgeSummary.magician.targets[0] + '&' + judgeSummary.magician.targets[1] : 'æ— '}}
            </text>
          </view>
          <!-- é‡å­©å­ -->
          <view class="sum-item" wx:if="{{judgeSummary.wild_child}}">
            <text>ğŸ‘¶ æ¦œæ ·:</text>
            <text class="{{judgeSummary.wild_child.model ? '' : 'dim'}}">
              {{judgeSummary.wild_child.model ? judgeSummary.wild_child.model + 'å·' : 'æœªé€‰'}}
            </text>
          </view>
        </view>
      </view>
    </view>
    <!-- 3. Controls -->
    <view class="judge-actions-row" style="display: flex; gap: 20rpx; justify-content: flex-end;">
      <button size="mini" type="primary" bindtap="onDevSimulate" wx:if="{{hasBots}}" style="background: rgba(82, 196, 26, 0.2) !important; color: #52c41a; border: 1rpx solid #52c41a;">
        ğŸ¤– æœºå™¨äººæ‰˜ç®¡
      </button>
      <button size="mini" type="warn" bindtap="onNextPhase" style="background: #ff4d4f !important; color: #fff;">
        â­ï¸ ä¸‹ä¸€é˜¶æ®µ
      </button>
    </view>
  </view>
  <!-- æ‚¬æµ®æ—¥å¿—æŒ‰é’® -->
  <!-- èº«ä»½å¡ç‰‡ (å³ä¾§æ‚¬æµ®) -->
  <!-- åº•éƒ¨èœå•æ  (ä»…æ™®é€šç©å®¶) -->
  <view class="game-tools-bar" wx:if="{{gameState.game_state.status === 'playing' && !isJudge && !isCreator}}">
    <view class="tool-item" bindtap="toggleLog">
      <view class="tool-icon">ğŸ“œ</view>
      <text class="tool-label">è®°å½•</text>
    </view>
    <view class="tool-item" bindtap="toggleTheaterMode">
      <view class="tool-icon">{{isTheaterMode ? 'ğŸ”³' : 'ğŸ”²'}}</view>
      <text class="tool-label">è§†é‡</text>
    </view>
    <view class="tool-item" bindtap="toggleRoleCard">
      <view class="tool-icon">ğŸ†”</view>
      <text class="tool-label">èº«ä»½</text>
    </view>
  </view>
  <!-- æ—¥å¿—å¼¹çª— -->
  <view class="log-modal {{showLog ? 'show' : ''}}" hidden="{{!showLog}}">
    <view class="log-header">
      <view class="log-tabs" style="display: flex; gap: 40rpx; font-size: 32rpx;">
        <view class="log-tab {{logTab === 'vote' ? 'active' : ''}}" bindtap="switchLogTab" data-tab="vote" style="{{logTab === 'vote' ? 'color: #ffd700; border-bottom: 4rpx solid #ffd700; padding-bottom: 10rpx;' : 'color: #888;'}}">
          æŠ•ç¥¨
        </view>
        <view class="log-tab {{logTab === 'text' ? 'active' : ''}}" bindtap="switchLogTab" data-tab="text" style="{{logTab === 'text' ? 'color: #ffd700; border-bottom: 4rpx solid #ffd700; padding-bottom: 10rpx;' : 'color: #888;'}}">
          æ—¥å¿—
        </view>
      </view>
      <view class="close-btn" bindtap="toggleLog">Ã—</view>
    </view>
    <scroll-view scroll-y class="log-content">
      <!-- 1. æŠ•ç¥¨è®°å½• Tab -->
      <block wx:if="{{logTab === 'vote'}}">
        <block wx:for="{{enrichedVotingHistory}}" wx:for-item="round" wx:key="index">
          <view class="voting-round">
            <view class="voting-round-title">
              Day {{round.day}} {{round.phase === 'sheriff_election' ? 'è­¦é•¿ç«é€‰' : (round.phase === 'sheriff_pk_voting' ? 'è­¦é•¿PK' : (round.phase === 'pk_voting' ? 'PKæŠ•ç¥¨' : 'æ”¾é€æŠ•ç¥¨'))}}
            </view>
            <view class="voting-grid">
              <block wx:for="{{round.enrichedVotes}}" wx:for-item="group" wx:key="targetSeat">
                <view class="vote-row" style="justify-content: space-between; align-items: stretch;">
                  <!-- å·¦ä¾§ï¼šæŠ•ç¥¨è€…åˆ—è¡¨ -->
                  <view class="voters-list" style="display: flex; flex-wrap: wrap; gap: 10rpx; flex: 1;">
                    <block wx:for="{{group.voters}}" wx:for-item="voter" wx:key="seat">
                      <view class="player-mini">
                        <image class="avatar-mini" src="{{voter.avatar}}"></image>
                        <text class="seat-mini">{{voter.seat}}å·</text>
                      </view>
                    </block>
                  </view>
                  <!-- ä¸­é—´ï¼šç®­å¤´ -->
                  <view class="vote-arrow-box" style="display: flex; align-items: center; padding: 0 20rpx;">
                    <text class="vote-arrow-icon">â”</text>
                  </view>
                  <!-- å³ä¾§ï¼šç›®æ ‡ -->
                  <view class="player-mini" style="align-self: center;">
                    <block wx:if="{{!group.isAbstain}}">
                      <image class="avatar-mini target-border" src="{{group.targetAvatar}}"></image>
                      <text class="seat-mini target-text">{{group.targetSeat}}å·</text>
                    </block>
                    <block wx:else>
                      <view class="abstain-box">å¼ƒç¥¨</view>
                    </block>
                  </view>
                </view>
              </block>
            </view>
          </view>
        </block>
        <view wx:if="{{!enrichedVotingHistory || enrichedVotingHistory.length === 0}}" style="text-align: center; color: #666; margin-top: 50rpx;">
          æš‚æ— æŠ•ç¥¨è®°å½•
        </view>
      </block>
      <!-- 2. æ–‡æœ¬æ—¥å¿— Tab -->
      <block wx:if="{{logTab === 'text'}}">
        <block wx:for="{{gameState.timeline}}" wx:key="index">
          <view class="log-item">
            <text class="log-time">Day {{item.day}}</text>
            <text class="log-text">{{item.text}}</text>
          </view>
        </block>
        <block wx:if="{{gameState.game_state.status === 'finished'}}">
          <view style="text-align: center; margin: 40rpx 0 20rpx; color: #ffd700; font-weight: bold; font-size: 28rpx;">
            --- å±€åå¤ç›˜ ---
          </view>
          <!-- é¢„è¨€å®¶éªŒäººä¿¡æ¯ -->
          <block wx:for="{{gameState.players}}" wx:key="seat" wx:if="{{item.role === 'seer'}}">
            <view class="log-item-box" style="margin-bottom: 20rpx;">
              <view class="log-time" style="color: #1890ff;">ğŸ”® é¢„è¨€å®¶ ({{item.seat}}å·)</view>
              <view class="log-text" style="color: #eee;">
                <block wx:if="{{item.role_state.check_history && item.role_state.check_history.length}}">
                  <view wx:for="{{item.role_state.check_history}}" wx:for-item="check" wx:key="day" style="margin-top: 5rpx;">
                    ç¬¬{{check.day}}å¤œ: æŸ¥éªŒ {{check.seat}}å· ->
                    <text style="color: {{check.isBad ? '#ff4d4f' : '#52c41a'}}">
                      {{check.isBad ? 'ç‹¼äºº' : 'å¥½äºº'}}
                    </text>
                  </view>
                </block>
                <view wx:else>æ— æŸ¥éªŒè®°å½•</view>
              </view>
            </view>
          </block>
          <!-- å¥³å·«ç”¨è¯ä¿¡æ¯ -->
          <block wx:for="{{gameState.players}}" wx:key="seat" wx:if="{{item.role === 'witch'}}">
            <view class="log-item-box" style="margin-bottom: 20rpx;">
              <view class="log-time" style="color: #722ed1;">ğŸ§™â€â™€ï¸ å¥³å·« ({{item.seat}}å·)</view>
              <view class="log-text" style="color: #eee;">
                <view>è§£è¯: {{item.role_state.witch_save_used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}}</view>
                <view>æ¯’è¯: {{item.role_state.witch_poison_used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'}}</view>
              </view>
            </view>
          </block>
        </block>
        <view wx:if="{{(!gameState.timeline || gameState.timeline.length === 0) && gameState.game_state.status !== 'finished'}}" style="text-align: center; color: #666; margin-top: 50rpx;">
          æš‚æ— è®°å½•
        </view>
      </block>
    </scroll-view>
  </view>
  <!-- èº«ä»½ç‰ŒæŒ‰é’® -->
  <!-- èº«ä»½ç‰Œå¼¹çª— -->
  <view class="role-modal {{showRoleCard ? 'show' : ''}}" bindtap="toggleRoleCard" hidden="{{!showRoleCard}}">
    <view class="role-card-3d {{roleCardFlipped ? 'flipped' : ''}}" catchtap="onCardTap">
      <view class="role-card-inner">
        <!-- èƒŒé¢: åˆå§‹æ˜¾ç¤º -->
        <view class="role-card-face role-card-back">
          <view class="card-pattern"></view>
          <view class="card-logo">ID</view>
          <view class="card-hint">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹èº«ä»½</view>
        </view>
        <!-- æ­£é¢: èº«ä»½ä¿¡æ¯ -->
        <view class="role-card-face role-card-front">
          <view class="role-title">æ‚¨çš„èº«ä»½</view>
          <view class="role-name-large">{{isJudge ? 'æ³•å®˜' : utils.getRoleName(myRole)}}</view>
          <view class="role-emoji-large" style="font-size: 160rpx; margin-bottom: 40rpx; text-shadow: 0 10rpx 20rpx rgba(0,0,0,0.5);">
            <text wx:if="{{isJudge}}">âš–ï¸</text>
            <text wx:elif="{{myRole==='werewolf'}}">ğŸº</text>
            <text wx:elif="{{myRole==='villager'}}">ğŸ§‘â€ğŸŒ¾</text>
            <text wx:elif="{{myRole==='seer'}}">ğŸ”®</text>
            <text wx:elif="{{myRole==='witch'}}">ğŸ§™â€â™€ï¸</text>
            <text wx:elif="{{myRole==='hunter'}}">ğŸ”«</text>
            <text wx:elif="{{myRole==='guard'}}">ğŸ›¡ï¸</text>
            <text wx:elif="{{myRole==='idiot'}}">ğŸ¤¡</text>
            <text wx:elif="{{myRole==='cupid'}}">ğŸ’˜</text>
            <text wx:else>â“</text>
          </view>
          <view class="role-desc">
            <text wx:if="{{isJudge}}">æ‚¨æ˜¯æœ¬å±€çš„ä¸Šå¸ï¼Œæ‹¥æœ‰å…¨åœºæœ€é«˜è§†è§’ã€‚æ‚¨å¯ä»¥è§‚å¯Ÿæ‰€æœ‰ç©å®¶çš„çœŸå®èº«ä»½åŠå¤œé—´è¡ŒåŠ¨ã€‚</text>
            <text wx:elif="{{myRole==='werewolf'}}">æ¯å¤©æ™šä¸Šå¯ä»¥è¢­å‡»ä¸€åç©å®¶ã€‚</text>
            <text wx:elif="{{myRole==='seer'}}">æ¯å¤©æ™šä¸Šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„èº«ä»½ã€‚</text>
            <text wx:elif="{{myRole==='witch'}}">æ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ã€‚</text>
            <text wx:elif="{{myRole==='hunter'}}">å‡ºå±€æ—¶å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶ã€‚</text>
            <text wx:elif="{{myRole==='guard'}}">æ¯æ™šå®ˆæŠ¤ä¸€åç©å®¶ã€‚</text>
            <text wx:elif="{{myRole==='villager'}}">æ²¡æœ‰ç‰¹æ®ŠæŠ€èƒ½ï¼Œä¸»è¦é æ¨ç†ã€‚</text>
            <text wx:else>ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æŠ€èƒ½æè¿°ã€‚</text>
          </view>
          <!-- åŠ¨æ€å…³è”ä¿¡æ¯ -->
          <view class="teammate-box" wx:if="{{(myRole === 'werewolf' || myRole === 'hidden_wolf') && !isJudge}}">
            <view class="teammate-title" style="color: #ff4d4f;">ç‹¼äººåŒä¼´</view>
            <view class="teammate-list">
              <block wx:for="{{gameState.players}}" wx:key="seat">
                <view class="teammate-item" wx:if="{{item.role === 'werewolf' && item.seat !== mySeat}}">
                  {{item.seat}}å· {{item.nickname}}
                  <text wx:if="{{!item.is_alive}}" style="color: #666; font-size: 22rpx;">
                    (å·²å‡ºå±€)
                  </text>
                </view>
              </block>
            </view>
          </view>
          <button class="modal-explode-btn" wx:if="{{!isJudge && myRole === 'werewolf' && isAlive && gameState.game_state.phase !== 'night'}}" bindtap="onWolfExplode">
            ğŸ’¥ ç‹¼äººè‡ªçˆ†
          </button>
          
          <!-- New: Confirm Role Button (deal_cards phase) -->
          <view wx:if="{{gameState.game_state.sub_phase === 'deal_cards' && !isJudge}}" style="margin-top: 30rpx; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 999;">
            <button 
              catchtap="onConfirmRole" 
              disabled="{{hasConfirmedRole}}"
              class="confirm-btn"
              style="background: {{hasConfirmedRole ? 'rgba(82, 196, 26, 0.8)' : 'rgba(250, 173, 20, 0.9)'}}; color: #fff; width: 80%; font-size: 30rpx; border-radius: 40rpx; border: 2rpx solid rgba(255,255,255,0.3); padding: 10rpx 0; font-weight: bold; box-shadow: 0 4rpx 10rpx rgba(0,0,0,0.3);">
              {{hasConfirmedRole ? 'å·²ç¡®è®¤ï¼Œç­‰å¾…ä»–äºº' : 'æˆ‘çœ‹å¥½äº†'}}
            </button>
            <view style="color: rgba(255,255,255,0.8); font-size: 24rpx; margin-top: 15rpx; text-shadow: 0 2rpx 4rpx rgba(0,0,0,0.8);">
              ({{confirmedCount || 0}}/{{currentCount || 0}} å·²ç¡®è®¤)
            </view>
          </view>

          <view class="close-card-hint" bindtap="toggleRoleCard">ç‚¹å‡»ç©ºç™½å¤„æ”¶èµ·</view>
        </view>
      </view>
    </view>
  </view>
  <!-- Mark Player Modal -->
  <view hidden="{{ !showMarkModal }}" class="mark-modal-overlay" bindtap="hideMarkPlayerModal">
    <view class="mark-modal-content" catchtap="doNothing">
      <!-- catchtap to prevent modal closing when clicking inside -->
      <text class="modal-title">æ ‡è®° {{ currentMarkPlayerSeat }}å· ç©å®¶</text>
      <view class="mark-options">
        <block wx:for="{{ markOptions }}" wx:for-item="option" wx:key="value">
          <view class="mark-option {{ currentMark === option.value ? 'selected' : '' }}" bindtap="selectMarkOption" data-mark="{{ option.value }}">
            <!-- For marking, display text label directly -->
            <text class="option-label">{{ option.label }}</text>
          </view>
        </block>
      </view>
      <button class="confirm-mark-btn" bindtap="confirmMarkPlayer">ç¡®å®š</button>
      <button class="clear-mark-btn" bindtap="clearMarkPlayer">æ¸…é™¤æ ‡è®°</button>
    </view>
  </view>
  <!-- å½’ç¥¨ç»“ç®—å¼¹çª— -->
  <view class="log-modal {{showVoteResultModal ? 'show' : ''}}" style="z-index: 1500; height: 75vh;" hidden="{{!showVoteResultModal}}">
    <view class="log-header" style="border-bottom: 2rpx solid #ffd700;">
      <text>ğŸ“Š æœ¬è½®å½’ç¥¨è¯¦æƒ…</text>
      <view class="close-btn" bindtap="closeVoteResultModal" style="font-size: 32rpx; color: #888;">
        (è‡ªåŠ¨å…³é—­)
      </view>
    </view>
    <scroll-view scroll-y class="log-content">
      <block wx:if="{{currentVoteResult}}">
        <view class="vote-result-list" style="padding: 20rpx; padding-bottom: 40rpx;">
          <view class="voting-round-title" style="text-align:center; margin-bottom:20rpx; font-size: 32rpx; font-weight: bold; color: #ffd700;">
            {{currentVoteResult.phase === 'sheriff_election' ? 'è­¦é•¿ç«é€‰ç»“æœ' : 'æ”¾é€æŠ•ç¥¨ç»“æœ'}}
          </view>
          <block wx:for="{{currentVoteResult.enrichedVotes}}" wx:for-item="group" wx:key="targetSeat">
            <view class="vote-result-card" style="background: rgba(255,255,255,0.08); border-radius: 20rpx; padding: 20rpx; margin-bottom: 20rpx; display: flex; align-items: center; justify-content: space-between;">
              <!-- å·¦ä¾§ï¼šæŠ•ç¥¨è€…é˜µè¥ -->
              <view class="voter-group" style="flex: 1; display: flex; flex-wrap: wrap; gap: 8rpx;">
                <block wx:for="{{group.voters}}" wx:for-item="voter" wx:key="seat">
                  <view class="voter-avatar-box" style="position: relative;">
                    <image src="{{voter.avatar}}" style="width: 60rpx; height: 60rpx; border-radius: 50%; border: 2rpx solid #aaa;"></image>
                    <view style="position: absolute; bottom: -10rpx; left: 0; right: 0; background: #333; color: #fff; font-size: 18rpx; text-align: center; border-radius: 10rpx; opacity: 0.9;">
                      {{voter.seat}}å·
                    </view>
                  </view>
                </block>
              </view>
              <!-- ä¸­é—´ï¼šç®­å¤´ä¸ç¥¨æ•° -->
              <view class="vote-arrow-section" style="margin: 0 20rpx; display: flex; flex-direction: column; align-items: center;">
                <text style="font-size: 24rpx; color: #ffd700; font-weight: bold;">
                  {{group.voters.length}}ç¥¨
                </text>
                <text style="font-size: 40rpx; color: #aaa; line-height: 1;">â”</text>
              </view>
              <!-- å³ä¾§ï¼šè¢«æŠ•ç›®æ ‡ -->
              <view class="target-group" style="width: 100rpx; display: flex; flex-direction: column; align-items: center;">
                <block wx:if="{{!group.isAbstain}}">
                  <image src="{{group.targetAvatar}}" style="width: 80rpx; height: 80rpx; border-radius: 50%; border: 4rpx solid #ff4d4f; box-shadow: 0 0 10rpx rgba(255, 77, 79, 0.5);"></image>
                  <text style="font-size: 28rpx; font-weight: bold; color: #ff4d4f; margin-top: 6rpx;">
                    {{group.targetSeat}}å·
                  </text>
                </block>
                <block wx:else>
                  <view class="abstain-box" style="width: 80rpx; height: 80rpx; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40rpx;">
                    ğŸ˜¶
                  </view>
                  <text style="font-size: 24rpx; color: #aaa; margin-top: 6rpx;">å¼ƒç¥¨</text>
                </block>
              </view>
            </view>
          </block>
        </view>
      </block>
      <view wx:else style="text-align: center; margin-top: 100rpx; color: #666;">è·å–ç»“æœä¸­...</view>
    </scroll-view>
    <view style="display: flex; justify-content: center; padding-top: 10rpx;">
      <button class="primary-btn" style="width: 300rpx; height: 80rpx; line-height: 80rpx; border-radius: 40rpx; font-size: 28rpx; margin: 0; flex-shrink: 0;" bindtap="closeVoteResultModal">
        å…³é—­
      </button>
    </view>
  </view>
</view>
<!-- å¼ºåˆ¶æˆæƒå¼¹çª— -->
<view class="login-modal" wx:if="{{showAuthModal}}">
  <view class="modal-content">
    <view class="modal-title">æ¬¢è¿åŠ å…¥</view>
    <view class="modal-desc">è¯·å…ˆå®Œå–„ä¿¡æ¯å†å…¥åº§</view>
    <button class="avatar-btn" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
      <image class="avatar-preview" src="{{tempAvatarUrl || '../../images/icons/avatar.png'}}"></image>
      <text>ç‚¹å‡»è®¾ç½®å¤´åƒ</text>
    </button>
    <input type="nickname" class="nickname-input" placeholder="ç‚¹å‡»è®¾ç½®æ˜µç§°" bind:change="onNicknameChange" />
    <view class="modal-btns">
      <button type="primary" style="width: 100%" bindtap="confirmAuth">ä¿å­˜å¹¶ç»§ç»­</button>
    </view>
  </view>
</view>
<!-- æ¸¸æˆç»“æŸç»“ç®—å¼¹çª— -->
<view class="login-modal" wx:if="{{gameState.game_state.status === 'finished'}}">
  <view class="modal-content" style="border: 2rpx solid #ffd700;">
    <view class="modal-title" style="color: #ffd700; font-size: 48rpx;">
      {{gameState.game_state.winner === 'good' ? 'å¥½äººèƒœåˆ© ğŸŒ•' : 'ç‹¼äººèƒœåˆ© ğŸŒ‘'}}
    </view>
    <scroll-view scroll-y style="max-height: 500rpx; width: 100%; margin: 30rpx 0;">
      <block wx:for="{{gameState.players}}" wx:key="seat">
        <view style="display: flex; align-items: center; margin-bottom: 15rpx; background: rgba(255,255,255,0.1); padding: 10rpx; border-radius: 10rpx;">
          <image src="{{item.avatar_url || '../../images/icons/avatar.png'}}" style="width: 50rpx; height: 50rpx; border-radius: 50%; margin-right: 20rpx;"></image>
          <view style="flex: 1; font-size: 26rpx;">
            <text style="color: #aaa; margin-right: 10rpx;">{{item.seat}}å·</text>
            <text>{{item.nickname}}</text>
          </view>
          <view style="font-weight: bold; font-size: 26rpx; color: {{item.role === 'werewolf' ? '#ff4d4f' : '#52c41a'}}">
            {{utils.getRoleName(item.role)}}
          </view>
        </view>
      </block>
    </scroll-view>
    <view style="width: 100%; display: flex; justify-content: space-between; margin-top: 30rpx;">
      <button type="default" style="width: 48%;" bindtap="onBackHome">è¿”å›é¦–é¡µ</button>
      <button type="primary" style="width: 48%;" wx:if="{{isCreator}}" bindtap="onRestartGame">
        é‡æ–°å¼€å§‹
      </button>
    </view>
  </view>
</view>
<!-- è‡ªå®šä¹‰é€šç”¨å¼¹çª— -->
<custom-modal show="{{modalConfig.show}}" title="{{modalConfig.title}}" content="{{modalConfig.content}}" showCancel="{{modalConfig.showCancel}}" confirmText="{{modalConfig.confirmText}}" cancelText="{{modalConfig.cancelText}}" confirmColor="{{modalConfig.confirmColor}}" bind:confirm="onModalConfirm" bind:cancel="onModalCancel" />